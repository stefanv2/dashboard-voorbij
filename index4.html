<!DOCTYPE html>
<html lang="nl">
    <head>
        <meta charset="UTF-8">
        <title>Dashboard Voorbij</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <!-- Koppel externe CSS -->
        <link rel="stylesheet" href="style.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
    </head>
    <body>
        <div class="container">
            <!-- HEADER -->
            <header class="header">
                <div class="menu-container">
                    <!-- üçî Hamburger knop -->
                    <div class="hamburger" id="hamburger">
                        <img src="img/hamburger.jpg" alt="menu">
                    </div>
                    <h1>Dashboard Voorbij</h1>
                    <!-- üìã Verborgen links (dropdown) -->
                    <div id="menuLinks" class="menu-links"><a href="https://kavita.voorbij.duckdns.org" target="_blank">üìñ Kavita</a><a href="https://voorbij.duckdns.org/calibre-web" target="_blank">üìö Calibre-Web</a><a href="https://voorbij.duckdns.org/weekoverzicht.html" target="_blank">üóìÔ∏è Weekoverzicht</a>
                    </div>
                </div>
            </header>
            <div class="grid">
                <!-- =================== LINKERKOLOM =================== -->
                <div class="stack">
                    <!-- üêª BOMMEL QUOTE -->
                    <section class="card">
                        <div class="section-title">
                            üêª Bommel <span class="tag">quote</span>
                        </div>
                        <div class="bommel-wrap">
                            <img class="bommel-figure" id="bommel-img" src="/img/bommel/bommel1.png" alt="Bommel">
                            <div style="flex:1">
                                <div class="speech" id="quote">Laden‚Ä¶</div>
                                <div class="toolbar">
                                    <button class="btn" id="btn-new-quote">Nieuwe quote</button>
                                </div>
                            </div>
                        </div>
                    </section>
                    <!-- üß≠ POSTCODE -->
                    <section class="card">
                        <div class="section-title">
                            üß≠ Adres / Postcode <span class="tag">KTB</span>
                        </div>
                        <div class="postcode-grid">
                            <input class="input" id="pc" placeholder="Postcode (bv. 2014SL)">
                            <input class="input" id="hnr" placeholder="Huisnr (bv. 203)" type="number">
                            <button class="btn alt" id="btn-zoek">Zoek</button>
                        </div>
                        <div id="pc-res" class="muted">
                            Zoek op <em>postcode + huisnummer</em>. Resultaat verschijnt hier.
                        </div>
                    </section>
                    <!-- üåê STATUS VAN DIENSTEN -->
                    <section class="card">
                        <div class="section-title">üåê Online status</div>
                        <div id="service-status" class="status-grid">
                            <div class="status-item">
                                <span class="status-label">üìö Boeken pagina:</span>
                                <span id="status-calibre" class="lamp"></span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">üìñ Comic pagina:</span>
                                <span id="status-kavita" class="lamp"></span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">üßë‚Äçüíª Stefan:</span>
                                <span id="status-stefan" class="lamp stefan"></span>
                            </div>
                        </div>
                    </section>
                </div>
                <!-- =================== RECHTERKOLOM / BOEKEN & STRIPS =================== -->
                <section class="card">
                    <div class="section-title" style="justify-content: space-between">
                        <!-- üìöüìì TAB BUTTONS -->
                        <div class="tabs">
                            <button class="tab active" data-target="books">üìö Boeken</button>
                            <div class="tab-with-dice">
                                <button class="tab" data-target="comics">üìì Strips</button>
                                <button class="btn" id="btn-random-comics"><i class="fa-solid fa-dice"></i>
                                </button>
                            </div>
                        </div>
                        <!-- üîç Zoekbalk + knoppen voor boeken -->
                        <div class="books-toolbar">
                            <input class="input" id="book-q" placeholder="Zoek titel / auteur">
                            <button class="btn" id="btn-search">Zoek</button>
                            <button class="btn alt" id="btn-newest">Nieuw</button>
                            <button class="btn" id="btn-random" title="Willekeurig boek"><i class="fa-solid fa-dice"></i>
                            </button>
                        </div>
                    </div>
                    <!-- üìö BOEKEN GRID (standaard actief) -->
                    <div id="books" class="tab-content active books-grid"></div>
                    <!-- üìì STRIPS TAB (alleen strip covers + dobbelsteen button) -->
                    <div id="comics" class="tab-content" style="display:none;">
                        <div class="comics-toolbar">
                            <button class="btn" id="btn-random-comics" title="Willekeurige strips"><i class="fa-solid fa-dice"></i>
                            </button>
                        </div>
                        <div id="comic-list" class="books-grid">
                            üìö Strip-collectie wordt geladen...
</div>
                    </div>
                </section>
                <!-- ============= JAVASCRIPT FUNCTIONALITEIT ============= -->
                <script>
	
// üçî Toggle hamburger menu
const hamburger = document.querySelector('.hamburger img');
const menuLinks = document.querySelector('.menu-links');

// Toggle open/dicht bij klik op hamburger
hamburger.addEventListener('click', (e) => {
  e.stopPropagation(); // voorkomt dat het meteen sluit
  menuLinks.classList.toggle('show');
});

// ‚úÖ Sluit menu automatisch bij klik buiten het menu
document.addEventListener('click', (e) => {
  if (!menuLinks.contains(e.target) && !hamburger.contains(e.target)) {
    menuLinks.classList.remove('show');
  }
});

// ‚úÖ Sluit menu ook bij klik op een menu-link
menuLinks.querySelectorAll('a').forEach(link => {
  link.addEventListener('click', () => {
    menuLinks.classList.remove('show');
  });
});
	
// üêª Bommel plaatje rotatie
const bommelPics = [
  '/img/bommel/bommel1.png',
  '/img/bommel/bommel2.png',
  '/img/bommel/bommel3.png',
  '/img/bommel/bommel4.png',
  '/img/bommel/bommel5.png'
];

let bommelIndex = 0;
function rotateBommel() {
  const img = document.getElementById('bommel-img');
  bommelIndex = (bommelIndex + 1) % bommelPics.length;
  img.style.opacity = 0;  // fade out
  setTimeout(() => {
    img.src = bommelPics[bommelIndex];
    img.style.opacity = 1;  // fade in
  }, 300);
}

// ‚è±Ô∏è elke 10 seconden wisselen
setInterval(rotateBommel, 20000);

// üåê STATUS LAMPJES CHECK ‚Äî tolerant voor opaque responses (CORS)
async function checkService(url, lampId) {
  const lamp = document.getElementById(lampId);
  if (!lamp) return;

  try {
    const res = await fetch(url, { method: "HEAD", mode: "no-cors" });

    // Bij mode:no-cors krijg je altijd een opaque response
    // ‚Üí beschouwen we als 'online' als er geen netwerkfout was
    lamp.classList.add("online");
  } catch (e) {
    lamp.classList.add("offline");
  }
}

// üåê STATUS CHECK MET HERHALING
window.addEventListener("load", () => {
  // eerste check meteen bij laden
  checkService("https://calibre.voorbij.duckdns.org", "status-calibre", "text-calibre");
  checkService("https://kavita.voorbij.duckdns.org", "status-kavita", "text-kavita");

  // daarna elke minuut herhalen
  setInterval(() => {
    checkService("https://calibre.voorbij.duckdns.org", "status-calibre", "text-calibre");
    checkService("https://kavita.voorbij.duckdns.org", "status-kavita", "text-kavita");
  }, 60000); // 60000ms = 1 minuut
});


// üé≤ Animatie voor strips-dobbelsteen
document.getElementById('btn-random-comics').addEventListener('click', () => {
  const icon = document.querySelector('#btn-random-comics i');
  icon.classList.add('dice-rolling');
  setTimeout(() => {
    icon.classList.remove('dice-rolling');
  }, 500);

  loadComics(); // opnieuw willekeurige strips tonen
});
				
// üìå Strips tonen ZONDER backend ‚Äî alleen lokale PNG's
function loadComics() {
  const container = document.getElementById('comic-list');
  container.innerHTML = '';

  // Alle beschikbare covers
  const covers = [
    'v233_c3083.png', 'v53_c1782.png', 'v54_c1805.png',
    'v13_c748.png', 'v55_c1886.png', 'v57_c1988.png','v57_c1944.png',
	'v233_c3085.png','v66_c2089.png','v70_c2125.png','v71_c2146.png',
    'v77_c2202.png','v78_c2279.png','v226_c2922.png','v238_c3187.png',
    'v238_c3374.png','v239_c3527.png','v241_c3597.png','v243_c3618.png',
	'v246_c3694.png','v246_c3783.png','v266_c4087.png',
	'v270_c4269.png','v273_c4490.png','v276_c4726.png','v280_c4854.png','v30_c1230.png'	
  ];

  // Schud de lijst en pak de eerste 4
  const randomCovers = covers
    .sort(() => Math.random() - 0.5)
    .slice(0, 6);

  randomCovers.forEach(file => {
    const src = `/img/comic_covers/${file}`;
    const wrapper = document.createElement('div');
    wrapper.className = 'book';
    wrapper.innerHTML = `
      <a href="https://kavita.voorbij.duckdns.org" target="_blank">
        <img src="${src}" alt="Random comic">
      </a>
    `;
    container.appendChild(wrapper);
  });
}

	
    // ===== API ENDPOINTS =====
    const HOST = window.location.hostname;
    const BASE = `https://${HOST}`;
    const API_BOMMEL   = `${BASE}/quote`;
    const API_BOOKS    = `${BASE}/slack/api/books`;
    const API_POSTCODE = `${BASE}/slack/api/postcode`;

    // ===== HELPER FUNCTIES =====
    async function safeFetch(url) {
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    }

    function el(tag, cls) {
      const e = document.createElement(tag);
      if (cls) e.className = cls;
      return e;
    }

    // ===== BOMMEL =====
    async function loadQuote() {
      try {
        const data = await safeFetch(API_BOMMEL);
        document.getElementById('quote').textContent = data.quote || "Geen quote gevonden.";
      } catch {
        document.getElementById('quote').textContent = "Kon geen quote laden.";
      }
    }

    // ===== BOEKEN =====
    function renderBooks(rows) {
      const wrap = document.getElementById('books');
      wrap.innerHTML = '';
      if (!rows || rows.length === 0) {
        wrap.textContent = "Geen boeken gevonden.";
        return;
      }
      rows.slice(0, 4).forEach(row => {
        const card = el('div', 'book');
        const img = el('img');
        img.src = row.cover || '/img/no-cover.png';
        img.onerror = () => { img.src='/img/no-cover.png'; };

        const meta = el('div');
        const title = el('h4'); title.textContent = row.title || "Onbekende titel";
        const author = el('div','author'); author.textContent = row.author || "Onbekende auteur";
        const desc = el('div','desc'); desc.textContent = row.description || "";
        
	// üõ† Extract only the path (/book/ID)
        let path = row.link;

        // als de link begint met http, strip domain eraf
        if (path.startsWith("http")) {
        path = new URL(path).pathname;   // resultaat: /book/5717
        }     

        const link = el('a','a');
        link.href = `https://calibre.voorbij.duckdns.org${path}`;
        link.target = "_blank";
        link.textContent = "Bekijk in Calibre-Web";

        meta.appendChild(title);
        meta.appendChild(author);
        meta.appendChild(desc);
        meta.appendChild(link);

        card.appendChild(img);
        card.appendChild(meta);
        wrap.appendChild(card);
      });
    }

    async function loadBooksNewest() {
      try { renderBooks(await safeFetch(`${API_BOOKS}?query=new`)); }
      catch { renderBooks([]); }
    }

    async function loadBooksRandom() {
      try { renderBooks(await safeFetch(`${API_BOOKS}?query=random`)); }
      catch { renderBooks([]); }
    }

    async function searchBooks() {
      const q = document.getElementById('book-q').value.trim();
      if (!q) return loadBooksRandom();
      try { renderBooks(await safeFetch(`${API_BOOKS}?query=${encodeURIComponent(q)}`)); }
      catch { renderBooks([]); }
    }

    // ===== POSTCODE + OPENSTREETMAP =====
    function renderPostcodeOk(row) {
      const elRes = document.getElementById('pc-res');
      const adres = `${row.straat} ${row.huisnummer}, ${row.plaats} (${row.postcode})`;

      if (row.lat && row.lon) {
        const lat = parseFloat(row.lat);
        const lon = parseFloat(row.lon);
        elRes.innerHTML = `
          <span class="ok">‚úÖ</span> ${adres}<br>
          <iframe
            class="osm-map"
            width="100%"
            height="250"
            frameborder="0"
            scrolling="no"
            src="https://www.openstreetmap.org/export/embed.html?bbox=${lon-0.002},${lat-0.002},${lon+0.002},${lat+0.002}&layer=mapnik&marker=${lat},${lon}">
          </iframe>
        `;
      } else {
        elRes.innerHTML = `<span class="ok">‚úÖ</span> ${adres} (Geen kaart beschikbaar)`;
      }
    }

    function renderPostcodeBad(msg) {
      document.getElementById('pc-res').innerHTML = `<span class="bad">‚úñ</span> ${msg}`;
    }

    async function doPostcode() {
      const pc = document.getElementById('pc').value.trim();
      const nr = document.getElementById('hnr').value.trim();
      if (!pc || !nr) return renderPostcodeBad("Geef postcode √©n huisnummer.");
      try { renderPostcodeOk(await safeFetch(`${API_POSTCODE}?pc=${pc}&nr=${nr}`)); }
      catch { renderPostcodeBad("Niet gevonden / fout in API."); }
    }

    // ===== EVENT LISTENERS =====
    document.getElementById('btn-new-quote').addEventListener('click', loadQuote);
    document.getElementById('btn-newest').addEventListener('click', loadBooksNewest);
    document.getElementById('btn-random').addEventListener('click', () => {
  const icon = document.querySelector('#btn-random i');

  // Start animatie
  icon.classList.add('dice-rolling');

  // Stop animatie na 0.5s
  setTimeout(() => {
    icon.classList.remove('dice-rolling');
  }, 500);

  // Willekeurige boeken laden
  loadBooksRandom();
});
    document.getElementById('btn-search').addEventListener('click', searchBooks);
    document.getElementById('btn-zoek').addEventListener('click', doPostcode);

    // ENTER-keys
    document.getElementById('book-q').addEventListener('keydown', e => e.key === 'Enter' && searchBooks());
    document.getElementById('pc').addEventListener('keydown', e => e.key === 'Enter' && doPostcode());
    document.getElementById('hnr').addEventListener('keydown', e => e.key === 'Enter' && doPostcode());

// üìöüìì Tabs functionaliteit + strips dobbelsteen
document.querySelectorAll('.tab').forEach(btn => {
  btn.addEventListener('click', () => {
    // Active tab styling
    document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    // Verberg alle content
    document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');

    const target = btn.getAttribute('data-target');
    document.getElementById(target).style.display = 'grid';

    // ‚úÖ Haal de strips-dobbelsteen op
    const comicDice = document.getElementById('btn-random-comics');
    const booksToolbar = document.querySelector('.books-toolbar');

    if (target === 'comics') {
      // üéØ Alleen strips ‚Üí dobbelsteen zichtbaar en boeken knoppen weg
      comicDice.style.display = 'inline-flex';
      booksToolbar.style.display = 'none';
      loadComics();
    } else {
      // üìö Op boeken-tab ‚Üí strips-dobbelsteen weg, zoekbalk terug
      comicDice.style.display = 'none';
      booksToolbar.style.display = 'flex';
    }
  });
});


    // ===== INIT =====
    loadQuote();
    loadBooksRandom();
  </script>
    </body>
</html>
